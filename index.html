<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試報告生成工具</title>
    <link rel="stylesheet" href="src/assets/styles.css">
    <link rel="stylesheet" href="src/quill/quill.snow.css">
</head>
<style>
    body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    margin: 0;
    padding: 20px;
    background-color: #f4f7f6;
    color: #333;
}

.container {
    max-width: 1000px;
    margin: auto;
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

h1, h2 {
    color: #0056b3;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 10px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

label {
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}

input[type="text"], input[type="date"], textarea, select {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
}

textarea {
    resize: vertical;
    min-height: 80px;
}

.test-case {
    border: 1px solid #dcdcdc;
    padding: 20px;
    margin-top: 20px;
    border-radius: 6px;
    background-color: #fafafa;
    position: relative;
}

.test-case-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s;
}

.btn-primary { background-color: #007bff; }
.btn-primary:hover { background-color: #0056b3; }
.btn-secondary { background-color: #28a745; }
.btn-secondary:hover { background-color: #218838; }
.btn-danger { background-color: #dc3545; font-size: 0.8rem; padding: 5px 10px; }
.btn-danger:hover { background-color: #c82333; }

#report-output {
    margin-top: 30px;
    border: 1px solid #ccc;
    padding: 20px;
    background-color: #fff;
    border-radius: 6px;
}

.report-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.report-table th, .report-table td {
    border: 1px solid #ddd;
    padding: 12px;
    text-align: left;
    vertical-align: top;
}

.report-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.result-Pass { color: #28a745; font-weight: bold; }
.result-Fail { color: #dc3545; font-weight: bold; }
.result-N\/A { color: #6c757d; font-weight: bold; }

.remove-case-btn {
    position: absolute;
    top: 10px;
    right: 10px;
}

#copy-btn-container {
    text-align: right;
    margin-top: 15px;
}

/* Quill editor styles */
.ql-container {
    border: 1px solid #ccc;
    border-radius: 4px;
}

.ql-toolbar {
    border: 1px solid #ccc;
    border-radius: 4px 4px 0 0;
}

.ql-editor {
    min-height: 150px;
}
</style>
<body>

    <div class="container">
        <h1>測試報告生成工具</h1>
        
        <form id="reportForm">
            <fieldset>
                <legend>專案資訊</legend>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="projectName">專案名稱</label>
                        <input type="text" id="projectName" value="Project-X" required>
                    </div>
                    <div class="form-group">
                        <label for="projectVersion">版本號</label>
                        <input type="text" id="projectVersion" value="1.0.0" required>
                    </div>
                    <div class="form-group">
                        <label for="testerName">測試人員</label>
                        <input type="text" id="testerName" value="Your Name" required>
                    </div>
                    <div class="form-group">
                        <label for="testDate">測試日期</label>
                        <input type="date" id="testDate" required>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>測試案例 (可拖曳排序)</legend>
                <div id="testCasesContainer"></div>
            </fieldset>
            
            <button type="button" id="addTestCaseBtn" class="btn btn-secondary" style="margin-top: 10px;">+ 新增測試案例</button>

            <hr style="margin: 30px 0;">

            <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 1.2rem;">產生報告</button>
        </form>

        <div id="report-output" style="display: none; margin-top: 30px; border: 1px solid #ddd; padding: 20px;">
            </div>
    </div>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">    
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <!-- <script src="src/js/app.js" defer></script> -->

    <script>

        class TestReportTool {
    constructor() {
        // --- 1. 選取所有必要的 DOM 元素 ---
        this.reportForm = document.getElementById('reportForm');
        this.testCasesContainer = document.getElementById('testCasesContainer');
        this.addTestCaseBtn = document.getElementById('addTestCaseBtn');
        this.reportOutput = document.getElementById('report-output');

        if (!this.reportForm || !this.testCasesContainer || !this.addTestCaseBtn) {
            console.error('重要的 UI 元素缺失，請檢查 HTML 結構!');
            return;
        }

        this.testCaseIdCounter = 0;
        this.quillInstances = new Map(); // 用來存放每個 Quill 實例

        // --- 2. 初始化函式庫與事件監聽 ---
        this.initSortable();
        this.initEventListeners();
        
        // --- 3. 初始時先新增一個測試案例 ---
        this.addTestCase();
    }

    initSortable() {
        new Sortable(this.testCasesContainer, {
            animation: 150,
            handle: '.test-case-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
        });
    }

    initEventListeners() {
        this.addTestCaseBtn.addEventListener('click', () => this.addTestCase());
        this.reportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.generateReport();
        });
    }

    addTestCase() {
        this.testCaseIdCounter++;
        const caseId = this.testCaseIdCounter;

        const testCaseHTML = `
            <div class="test-case" id="test-case-${caseId}">
                <div class="test-case-header">
                    <span class="test-case-handle">☰</span>
                    <h3 class="test-case-title">測試案例 #${caseId}</h3>
                    <button type="button" class="btn-remove-case" data-case-id="${caseId}">×</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="case-name-${caseId}">案例名稱</label>
                        <input type="text" id="case-name-${caseId}" class="test-case-name" placeholder="例如：使用者登入測試">
                    </div>
                    <div class="form-group">
                        <label for="case-status-${caseId}">測試結果</label>
                        <select id="case-status-${caseId}" class="test-case-status">
                            <option value="Pass" selected>通過 (Pass)</option>
                            <option value="Fail">失敗 (Fail)</option>
                            <option value="Skip">忽略 (Skip)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>實際結果與截圖</label>
                    <div class="quill-editor" id="quill-editor-${caseId}"></div>
                </div>
            </div>
        `;
        
        this.testCasesContainer.insertAdjacentHTML('beforeend', testCaseHTML);

        const quill = new Quill(`#quill-editor-${caseId}`, {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: '在此描述測試的實際結果，可貼上截圖...'
        });

        this.quillInstances.set(caseId, quill); // 將 Quill 實例儲存起來

        document.querySelector(`.btn-remove-case[data-case-id="${caseId}"]`).addEventListener('click', (e) => {
            const caseElement = e.currentTarget.closest('.test-case');
            const idToRemove = parseInt(caseElement.id.split('-')[2]);
            this.quillInstances.delete(idToRemove); // 移除對應的 Quill 實例
            caseElement.remove();
        });
    }

    /**
     * 產生最終的測試報告 (已修正)
     */
    generateReport() {
        console.log('開始產生報告...'); // 除錯用

        // --- 修正後的數據統計邏輯 ---
        const allStatusSelects = this.reportForm.querySelectorAll('.test-case-status');
        let passCount = 0;
        let failCount = 0;
        let skipCount = 0;
        allStatusSelects.forEach(select => {
            if (select.value === 'Pass') passCount++;
            else if (select.value === 'Fail') failCount++;
            else if (select.value === 'Skip') skipCount++;
        });

        const chartData = {
            labels: ['通過 (Pass)', '失敗 (Fail)', '忽略 (Skip)'],
            values: [passCount, failCount, skipCount]
        };

        // --- 新增：收集詳細報告內容 ---
        let detailsContent = '';
        const testCases = this.reportForm.querySelectorAll('.test-case');
        testCases.forEach((caseEl, index) => {
            const caseId = parseInt(caseEl.id.split('-')[2]);
            const caseName = caseEl.querySelector('.test-case-name').value || `未命名案例 #${index + 1}`;
            const caseStatus = caseEl.querySelector('.test-case-status').value;
            const quill = this.quillInstances.get(caseId);
            const quillContent = quill ? quill.root.innerHTML : '<p><i>無法取得內容</i></p>';

            detailsContent += `
                <div class="report-detail-item">
                    <h4>${index + 1}. ${caseName}</h4>
                    <p><strong>測試結果:</strong> <span class="status-${caseStatus.toLowerCase()}">${caseStatus}</span></p>
                    <div><strong>詳細描述:</strong></div>
                    <div class="quill-content-render">${quillContent}</div>
                </div>
            `;
        });

        if (testCases.length === 0) {
            detailsContent = '<p>沒有可報告的測試案例。</p>';
        }

        const reportHTML = `
            <h2>測試結果總覽</h2>
            <div class="chart-container" style="max-width: 400px; margin: auto;">
                <canvas id="resultsChart"></canvas>
            </div>
            <hr>
            <h2>詳細報告</h2>
            <div id="report-details">${detailsContent}</div>
            <br>
            <button id="downloadReportBtn" class="btn btn-secondary">下載 PDF 報告</button>
        `;

        this.reportOutput.innerHTML = reportHTML;
        this.reportOutput.style.display = 'block';

        this.generateChart(chartData);

        document.getElementById('downloadReportBtn').addEventListener('click', () => this.downloadPDF());
    }

    // generateChart 和 downloadPDF 方法維持不變...
    // (為了簡潔，此處省略，請沿用上一版本的方法)
    generateChart(data) {
        const ctx = document.getElementById('resultsChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '測試結果',
                    data: data.values,
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(220, 53, 69, 0.7)',
                        'rgba(108, 117, 125, 0.7)'
                    ],
                    borderColor: ['#ffffff'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
    }

    downloadPDF() {
        const element = this.reportOutput;
        const projectName = document.getElementById('projectName').value || 'report';
        const opt = {
          margin:       [0.5, 0.5, 0.5, 0.5], // 上、左、下、右 in inch
          filename:     `test-report-${projectName}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true, logging: false },
          jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        // 隱藏下載按鈕，避免出現在 PDF 中
        const downloadBtn = element.querySelector('#downloadReportBtn');
        if (downloadBtn) downloadBtn.style.display = 'none';

        html2pdf().from(element).set(opt).save().then(() => {
            // PDF 產生後，重新顯示按鈕
            if (downloadBtn) downloadBtn.style.display = 'block';
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new TestReportTool();
});
    </script>

</body>
</html>